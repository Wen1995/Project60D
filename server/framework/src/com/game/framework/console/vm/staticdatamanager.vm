package com.game.framework.resource;

import java.lang.reflect.Field;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.util.HashMap;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import com.game.framework.utils.ExternalStorageUtil;
import com.game.framework.utils.ReadOnlyMap;
import com.game.framework.utils.StringUtil;
import com.google.common.base.CaseFormat;
#foreach ($attr in ${classes})
import com.game.framework.resource.data.${attr[0]}.${attr[1]};
#end

public class StaticDataManager {
	private static Logger logger = LoggerFactory.getLogger(StaticDataManager.class);

    static Object obj = new Object();
    private static StaticDataManager instance;

    public static StaticDataManager GetInstance() {
        synchronized (obj) {
            if (instance == null) {
                instance = new StaticDataManager();
            }
        }
        return instance;
    }

    private static final String DIR = "config/data/";

#foreach ($attr in ${classes})
	public ReadOnlyMap<Integer, ${attr[1]}> ${attr[2]};
#end

	public void init() {
	#foreach ($attr in ${classes})
    ${attr[2]} = load(${attr[1]}.class);
    #end
}

    @SuppressWarnings("unchecked")
    public <T> ReadOnlyMap<Integer, T> load(Class<T> _class) {
        HashMap<Integer, T> hash = new HashMap<Integer, T>();
        try {
            String className = _class.getSimpleName();
            String lowClassName = StringUtil.AllLetterToLower(className);

            String sub_str = _class.getName().substring(0, _class.getName().indexOf("$") + 1);
            Class<?> arr_class = Class.forName(sub_str + className + "_ARRAY");
            Method parseFromMethod = arr_class.getMethod("parseFrom", byte[].class);

            Object arr = parseFromMethod.invoke(arr_class, ExternalStorageUtil.loadData(DIR + lowClassName + ".bytes"));
            Method arr_getItemsCountMethod = arr_class.getMethod("getItemsCount");
            Method arr_getItemsMethod = arr_class.getMethod("getItems", int.class);

            Method getIdMethod = _class.getMethod("getId");

            int item_size = (Integer) arr_getItemsCountMethod.invoke(arr);
            for (int i = 0; i < item_size; i++) {
                T item = (T) arr_getItemsMethod.invoke(arr, i);
                Integer id = (Integer) getIdMethod.invoke(item);
                hash.put(id, item);
            }
        } catch (ClassNotFoundException e) {
            logger.error("DataManager", e);
        } catch (SecurityException e) {
            logger.error("DataManager", e);
        } catch (NoSuchMethodException e) {
            logger.error("DataManager", e);
        } catch (IllegalArgumentException e) {
            logger.error("DataManager", e);
        } catch (IllegalAccessException e) {
            logger.error("DataManager", e);
        } catch (InvocationTargetException e) {
            logger.error("DataManager", e);
        }
        return new ReadOnlyMap<>(hash);
    }

    @SuppressWarnings({"unchecked", "rawtypes"})
    public Integer getSpeed(String tableName, Integer tableId) {
        String lowerCamelName = CaseFormat.UPPER_UNDERSCORE.to(CaseFormat.LOWER_CAMEL, tableName);
        String name = StringUtil.FirstLetterToUpper(lowerCamelName);
        String classPath = "com.game.framework.resource.data." + name + "Bytes$" + StringUtil.AllLetterToUpper(lowerCamelName);
        Integer speed = null;
        try {
            Field f = StaticDataManager.class.getDeclaredField(lowerCamelName + "Map");
            ReadOnlyMap map = (ReadOnlyMap) f.get(StaticDataManager.GetInstance());
            Class clazz = Thread.currentThread().getContextClassLoader().loadClass(classPath);
            Method method = clazz.getDeclaredMethod("get" + name + "Spd");
            speed = (Integer) method.invoke(map.get(tableId));
        } catch (ClassNotFoundException e) {
            logger.error("", e);
        } catch (NoSuchFieldException e) {
            logger.error("", e);
        } catch (SecurityException e) {
            logger.error("", e);
        } catch (IllegalArgumentException e) {
            logger.error("", e);
        } catch (IllegalAccessException e) {
            logger.error("", e);
        } catch (NoSuchMethodException e) {
            logger.error("", e);
        } catch (InvocationTargetException e) {
            logger.error("", e);
        }
        return speed;
    }
    
    @SuppressWarnings({"unchecked", "rawtypes"})
    public Integer getCapacity(String tableName, Integer tableId) {
        String lowerCamelName = CaseFormat.UPPER_UNDERSCORE.to(CaseFormat.LOWER_CAMEL, tableName);
        String name = StringUtil.FirstLetterToUpper(lowerCamelName);
        String classPath = "com.game.framework.resource.data." + name + "Bytes$" + StringUtil.AllLetterToUpper(lowerCamelName);
        Integer speed = null;
        try {
            Field f = StaticDataManager.class.getDeclaredField(lowerCamelName + "Map");
            ReadOnlyMap map = (ReadOnlyMap) f.get(StaticDataManager.GetInstance());
            Class clazz = Thread.currentThread().getContextClassLoader().loadClass(classPath);
            Method method = clazz.getDeclaredMethod("get" + name + "Cap");
            speed = (Integer) method.invoke(map.get(tableId));
        } catch (ClassNotFoundException e) {
            logger.error("", e);
        } catch (NoSuchFieldException e) {
            logger.error("", e);
        } catch (SecurityException e) {
            logger.error("", e);
        } catch (IllegalArgumentException e) {
            logger.error("", e);
        } catch (IllegalAccessException e) {
            logger.error("", e);
        } catch (NoSuchMethodException e) {
            logger.error("", e);
        } catch (InvocationTargetException e) {
            logger.error("", e);
        }
        return speed;
    }
}